<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ°å†‰å®‡å®™ç‡Ÿæ”¶è¡¨</title>
    <style>
        /* --- 100% åŸå§‹æ ¸å¿ƒæ¨£å¼å¾©åŸ --- */
        :root { --primary: #4E342E; --mid: #8D6E63; --light: #A89B96; --bg: #EAE3DD; }
        body.theme-green { --primary: #2D4030; --mid: #556B2F; --light: #A3B18A; --bg: #DAD7CD; }
        body.theme-blue { --primary: #1B263B; --mid: #415A77; --light: #778DA9; --bg: #E0E1DD; }
        body.theme-red { --primary: #582F0E; --mid: #7F4F24; --light: #A68A64; --bg: #EDE0D4; }
        body.theme-purple { --primary: #3C096C; --mid: #7B2CBF; --light: #9D4EDD; --bg: #E0AAFF; }

        body, html { height: 100%; margin: 0; padding: 0; font-family: sans-serif; background: var(--bg); overflow: hidden; display: flex; flex-direction: column; color: var(--primary); transition: background 0.5s; cursor: default; }
        
        /* Header å€åŸŸ */
        .header-section { height: 85px; padding: 0 40px; display: flex; align-items: center; flex-shrink: 0; }
        .page-title { font-size: 26px; font-weight: 900; cursor: pointer; user-select: none; margin-right: 30px; }
        .year-dropdown { position: absolute; top: 45px; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); width: 140px; display: none; z-index: 9999; border: 1px solid #EEE; overflow: hidden; }
        .year-item { padding: 12px; font-weight: 700; color: var(--mid); cursor: pointer; text-align: center; transition: 0.2s; }
        .year-item:hover { background: var(--bg); }

        /* æœå°‹å€åŸŸï¼šé–æ­»åœ¨å·¦å´ */
        .search-area { display: flex; align-items: center; }
        .search-group { display: flex; gap: 8px; }
        .search-group input { border: 1px solid rgba(0,0,0,0.08); border-radius: 50px; padding: 8px 15px; width: 110px; outline: none; background: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600; transition: all 0.4s; cursor: text; }
        .search-group input:focus { background: #FFF; width: 160px; border-color: var(--primary); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

        /* è§’è‰²æŒ‰éˆ•ï¼šæ¨åˆ°æœ€å³é‚Š */
        .role-btn-group { display: none; gap: 5px; margin-left: auto; }
        .role-btn { border: 1px solid var(--light); padding: 6px 15px; border-radius: 50px; font-size: 12px; font-weight: 700; cursor: pointer; background: white; color: var(--mid); transition: 0.3s; }
        .role-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .viewport { flex: 1; overflow: hidden; position: relative; }
        .slider-container { display: flex; width: 300vw; height: 100%; transition: transform 0.6s cubic-bezier(0.65, 0, 0.35, 1); }
        .page-content { width: 100vw; height: 100%; padding: 0 20px 100px 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        
        .white-card { background: white; border-radius: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.03); position: relative; }
        .table-scroll { flex: 1; overflow-y: scroll; width: 100%; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { border-collapse: collapse; width: 100%; table-layout: fixed; min-width: 1400px; }
        th { background: var(--primary); color: white; padding: 12px 2px; font-size: 11px; position: sticky; top: 0; z-index: 10; }
        td { border-bottom: 1px solid rgba(0,0,0,0.03); height: 38px; text-align: center; font-size: 13px; position: relative; }
        
        input[type="checkbox"] { width: 13px !important; height: 13px !important; cursor: pointer; accent-color: var(--primary); }
        
        /* çµæ¡ˆè®Šç°æ¨£å¼ */
        tr.is-settled { opacity: 0.4; filter: grayscale(1); transition: 0.3s; }
        tr.is-settled input, tr.is-settled select { color: #888; }
        
        input, select { border: none; width: 100%; height: 100%; text-align: center; font-size: 12px; background: transparent; outline: none; font-weight: 600; color: var(--primary); cursor: pointer; }
        input:focus, select:focus { cursor: text; }
        .readonly { color: var(--light); background: #FAF9F8; cursor: default; }

        /* åº•éƒ¨ UI */
        .bottom-ui-wrap { position: fixed; bottom: 30px; left: 0; width: 100%; padding: 0 40px; display: flex; align-items: center; justify-content: space-between; box-sizing: border-box; pointer-events: none; z-index: 1000; }
        .bottom-ui-wrap > * { pointer-events: auto; }
        .btn-group-left { display: flex; gap: 12px; width: 250px; } 
        .tab-bar-container { display: flex; gap: 5px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 50px; border: 1px solid #DDD; position: absolute; left: 50%; transform: translateX(-50%); box-shadow: 0 8px 25px rgba(0,0,0,0.08); backdrop-filter: blur(10px); }
        .btn-group-right { display: flex; justify-content: flex-end; width: 250px; }
        
        .tab-item { padding: 10px 22px; border-radius: 40px; cursor: pointer; font-size: 13px; font-weight: 700; color: var(--mid); transition: 0.3s; }
        .tab-item.active { background: var(--primary); color: white; transform: scale(1.05); }

        /* å·¦ä¸‹è§’æŒ‰éˆ•æ¨£å¼ (é˜²æ­¢è®Šåœ“çƒ) */
        .sync-btn { 
            padding: 10px 22px; border-radius: 50px; background: #FFF; border: 2px solid; 
            font-weight: 900; font-size: 13px; cursor: pointer; transition: 0.3s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); white-space: nowrap; 
            display: flex; align-items: center; gap: 5px; 
        }
        .sync-btn:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }

        /* --- å°ˆæ¥­é›™æ¬„å°å¸³å–®ç•«å¸ƒ --- */
        #invoice-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(40px); z-index: 50; display: none; padding: 25px 40px; box-sizing: border-box; flex-direction: column; overflow: hidden; }
        .inv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 3px solid var(--primary); padding-bottom: 5px; }
        .inv-header h1 { margin: 0; font-size: 24px; font-weight: 900; letter-spacing: 5px; color: var(--primary); }
        
        #inv-list-wrapper { flex: 1; column-count: 2; column-gap: 60px; column-rule: 1px solid rgba(0,0,0,0.1); overflow: hidden; padding-top: 10px; }
        .inv-item { break-inside: avoid; width: 100%; display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 12px 0; }
        .inv-col-id { width: 30px; color: var(--light); font-size: 10px; text-align: center; }
        .inv-col-info { flex: 1; display: flex; flex-direction: column; padding: 0 10px; }
        .inv-col-name { font-weight: 900; color: var(--primary); font-size: 14px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .inv-col-prices { display: flex; gap: 15px; font-size: 11px; font-weight: 700; color: var(--mid); }
        .price-tag { color: var(--light); font-weight: 400; margin-right: 3px; }
        .inv-col-total { width: 90px; text-align: right; font-weight: 900; color: #000; font-size: 15px; }

        .inv-footer { margin-top: auto; padding-top: 15px; display: flex; justify-content: flex-end; align-items: center; border-top: 1px solid rgba(0,0,0,0.1); }
        .inv-total-amt { font-size: 34px; font-weight: 900; color: #D32F2F; margin-left: 20px; }
    </style>
</head>
<body onclick="document.getElementById('yMenu').style.display='none'">

<div class="header-section">
    <div style="position:relative">
        <div class="page-title" onclick="event.stopPropagation(); document.getElementById('yMenu').style.display='block'"><span id="yDisp">2026</span> ç‡Ÿæ”¶è¡¨</div>
        <div id="yMenu" class="year-dropdown"><div id="yList"></div><div class="year-item" style="color:green; border-top:1px solid #EEE" onclick="addNewYear()">+</div></div>
    </div>
    
    <div class="search-area">
        <div class="search-group" id="searchInputs">
            <input type="text" id="sC" placeholder="ğŸ‘¤ å®¢æˆ¶æœå°‹" oninput="runSearch()">
            <input type="text" id="sM" placeholder="ğŸ“… æœˆä»½" oninput="runSearch()">
        </div>
        <div class="search-group" id="settleSearchGroup" style="display:none">
            <input type="text" id="ssC" placeholder="ğŸ” æœå°‹å®¢æˆ¶" oninput="runSettleSearch()">
            <input type="text" id="ssM" placeholder="ğŸ” çµç®—æœˆä»½" oninput="runSettleSearch()">
        </div>
    </div>

    <div class="role-btn-group" id="roleBtns">
        <button class="role-btn active" onclick="setRole('å…¬å¸', this)">å…¬å¸</button>
        <button class="role-btn" onclick="setRole('è€é—†', this)">è€é—†</button>
        <button class="role-btn" onclick="setRole('å“¡å·¥', this)">å“¡å·¥</button>
    </div>
</div>

<div class="viewport">
    <div class="slider-container" id="mainSlider">
        <div class="page-content">
            <div class="white-card">
                <div class="table-scroll" id="input-view">
                    <table>
                        <thead><tr><th style="width:70px">å¹´æœˆ</th><th style="width:45px">ç·¨è™Ÿ</th><th style="width:80px">å®¢æˆ¶</th><th style="width:120px">æ¡ˆä»¶åç¨±</th><th style="width:70px">é¡å‹</th><th style="width:80px">äº¤ä»¶æ—¥</th><th style="width:70px">ä»˜æ¬¾</th><th style="width:45px">ç™¼ç¥¨</th><th style="width:70px">è¨‚é‡‘</th><th style="width:80px">æœªç¨…é¡</th><th style="width:70px">ç¨…é‡‘</th><th style="width:80px">å«ç¨…ç¸½é¡</th><th style="width:80px">å°¾æ¬¾</th><th style="width:80px">æœªæ”¶é‡‘é¡</th><th style="width:65px">å…¬å¸%</th><th style="width:65px">è€é—†%</th><th style="width:65px">å“¡å·¥%</th><th style="width:80px">å…¬å¸é‡‘é¡</th><th style="width:80px">è€é—†é‡‘é¡</th><th style="width:80px">å“¡å·¥é‡‘é¡</th><th style="width:120px">å‚™è¨»</th></tr></thead>
                        <tbody id="tb"></tbody>
                    </table>
                </div>
                <div id="invoice-view">
                    <div class="inv-header"><h1>å°å¸³æ˜ç´°å–®</h1><div id="inv-cust-info" style="font-weight:900; font-size:16px; color:var(--mid);"></div></div>
                    <div id="inv-list-wrapper"></div>
                    <div class="inv-footer"><div style="font-size: 18px; font-weight: 900; color: var(--mid);">æ‡‰ä»˜ç¸½è¨ˆ (å«ç¨…)</div><div class="inv-total-amt" id="inv-total-amt">$ 0</div></div>
                </div>
            </div>
        </div>
        
        <div class="page-content"><div class="white-card"><div class="table-scroll"><table><thead><tr><th style="width:12%">å¹´æœˆ</th><th style="width:10%">ç·¨è™Ÿ</th><th style="width:18%">å®¢æˆ¶</th><th style="width:30%">æ¡ˆå</th><th style="width:15%">æˆäº¤æœªç¨…</th><th style="width:12%" id="sP">å…¬å¸ %</th><th style="width:15%" id="sA">é‡‘é¡ $</th></tr></thead><tbody id="settle-tb"></tbody></table></div><div id="settle-bar" style="height:70px; display:none; align-items:center; justify-content:flex-end; padding:0 40px; border-top:1px solid #EEE;"><div id="settle-total-val" style="color:#D32F2F; font-size:24px; font-weight:900;">çµç®—ç¸½é¡ï¼š$ 0</div></div></div></div>

        <div class="page-content"><div class="white-card"><div class="table-scroll"><table><thead><tr><th>æœˆä»½</th><th>æœªç¨…ç¸½æ”¶</th><th>å«ç¨…ç¸½æ”¶</th><th>å·²æ”¶é‡‘é¡</th><th>æ‡‰æ”¶é¤˜é¡</th><th>å…¬å¸åˆ†æ½¤</th><th>è€é—†åˆ†æ½¤</th><th>å“¡å·¥åˆ†æ½¤</th><th>æ¡ˆä»¶æ•¸</th></tr></thead><tbody id="report-tb"></tbody></table></div></div></div>
    </div>
</div>

<div class="bottom-ui-wrap">
    <div class="btn-group-left">
        <button class="sync-btn" id="cloudSaveBtn" style="border-color:#4285F4; color:#4285F4" onclick="cloudSync('SAVE')">â˜ï¸ é›²ç«¯åŒæ­¥</button>
        <button class="sync-btn" style="border-color:#FBBC05; color:#FBBC05" onclick="cloudSync('LOAD')">ğŸ”„ è¼‰å…¥é›²ç«¯</button>
    </div>
    <div class="tab-bar-container">
        <div class="tab-item active" onclick="switchSlide(0, this)">æ¡ˆä»¶æ˜ç´°</div>
        <div class="tab-item" onclick="switchSlide(1, this)">åˆ†æ½¤çµç®—</div>
        <div class="tab-item" onclick="switchSlide(2, this)">æœˆå ±çµ±è¨ˆ</div>
    </div>
    <div class="btn-group-right">
        <button class="sync-btn" style="border-color:#DDD; color:var(--mid)" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
    </div>
</div>

<script>
const CLOUD_API = "https://script.google.com/macros/s/AKfycby13dgio2KdDj-R3QhkzO73NKl9SygorGNKRja9KO5P9kpsRLt3ILMqY1Rgj53kjKgK/exec"; 
let curY = localStorage.getItem('vB_Y') || '2026';
let yArr = JSON.parse(localStorage.getItem('vB_List')) || ['2026'];
let opts = JSON.parse(localStorage.getItem('vB_Opts')) || { 4: [], 6: [] };
window.curRole = 'å…¬å¸';

function changeYear(y) { curY=y; localStorage.setItem('vB_Y',y); document.getElementById('yDisp').innerText=y; applyTheme(y); initTable(); }
function applyTheme(y) { const themes=['','theme-green','theme-blue','theme-red','theme-purple']; document.body.className=themes[parseInt(y)%themes.length]; }
function addNewYear() { let y=prompt("å¹´ä»½:"); if(y){ if(!yArr.includes(y)){yArr.push(y);yArr.sort();localStorage.setItem('vB_List',JSON.stringify(yArr));} changeYear(y); renderYearList(); } }
function renderYearList() { const l=document.getElementById('yList'); l.innerHTML=''; yArr.forEach(y=>l.innerHTML+=`<div class="year-item" onclick="changeYear('${y}')">${y}</div>`); }

function switchSlide(idx, el) {
    document.getElementById('mainSlider').style.transform = `translateX(-${idx * 100}vw)`;
    document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active')); el.classList.add('active');
    
    document.getElementById('searchInputs').style.display = (idx === 0) ? 'flex' : 'none';
    document.getElementById('settleSearchGroup').style.display = (idx === 1) ? 'flex' : 'none';
    document.getElementById('roleBtns').style.display = (idx === 1) ? 'flex' : 'none';
    document.getElementById('settle-bar').style.display = (idx === 1) ? 'flex' : 'none';
    if(idx === 1) { window.curRole = 'å…¬å¸'; runSettleSearch(); }
    if(idx === 2) updateMonthlyReport();
}

function runSearch() { 
    let sc = document.getElementById('sC').value.trim().toLowerCase();
    let sm = document.getElementById('sM').value.trim().padStart(2,'0'); 
    let rowCount = parseInt(localStorage.getItem(`rowCount_${curY}`)) || 65;
    let invView = document.getElementById('invoice-view');
    let invWrapper = document.getElementById('inv-list-wrapper');
    if (sc !== "" || (sm !== "" && sm !== "00")) {
        invView.style.display = 'flex'; invWrapper.innerHTML = '';
        document.getElementById('inv-cust-info').innerText = sc ? `å®¢æˆ¶ï¼š${sc.toUpperCase()}` : `æœˆä»½ï¼š${sm}æœˆ`;
        let results = []; let totalSum = 0;
        for(let r=0; r<rowCount; r++){ 
            let d = JSON.parse(localStorage.getItem(`d_${curY}_${r}`)) || {};
            if (((!sc || (d[2]||"").toLowerCase().includes(sc)) && (!sm || sm==='00' || (d[0]||"").includes(`-${sm}`))) && d[3]) {
                results.push(d); totalSum += parseFloat(String(d[11]).replace(/,/g,'')) || 0;
            }
        }
        let padding = results.length > 35 ? 2 : (results.length > 20 ? 6 : 10);
        results.forEach((d, index) => {
            invWrapper.innerHTML += `<div class="inv-item" style="padding:${padding}px 0;"><div class="inv-col-id">${String(index+1).padStart(2, '0')}</div><div class="inv-col-info"><div class="inv-col-name">${d[3]}</div><div class="inv-col-prices"><span><span class="price-tag">æœªç¨…:</span>${d[9]||'0'}</span><span><span class="price-tag">ç¨…é‡‘:</span>${d[10]||'0'}</span><span><span class="price-tag">å°è¨ˆ:</span>${d[11]||'0'}</span></div></div><div class="inv-col-total">${d[11]||'0'}</div></div>`;
        });
        document.getElementById('inv-total-amt').innerText = `$ ${totalSum.toLocaleString()}`;
    } else { invView.style.display = 'none'; }
}

function initTable() { const b = document.getElementById('tb'); b.innerHTML = ''; let count = parseInt(localStorage.getItem(`rowCount_${curY}`)) || 65; for(let r=0; r<count; r++) { b.appendChild(createRow(r)); calc(r, 0, false); } }
function setRole(r, el) { window.curRole = r; document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); runSettleSearch(); }

function createRow(r) {
    let tr = document.createElement('tr'); tr.id = `r${r}`;
    let saved = JSON.parse(localStorage.getItem(`d_${curY}_${r}`)) || {};
    for(let c=0; c<21; c++) {
        let td = document.createElement('td'), val = saved[c] || '';
        if(c===7) td.innerHTML=`<input type="checkbox" id="r${r}c${c}" ${val===true?'checked':''} onchange="calc(${r},${c})">`;
        else if(c===4 || c===6) {
            let ops = (opts[c]||[]).map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('');
            td.innerHTML = `<select id="r${r}c${c}" onchange="handleOptChange(${r},${c})"><option value="">--</option>${ops}<option value="__ADD__">+</option><option value="__DEL__">-</option></select>`;
        } else {
            let ro = [0,10,11,13,17,18,19].includes(c);
            td.innerHTML = `<input id="r${r}c${c}" value="${val}" class="${ro?'readonly':''}" ${ro?'readonly tabindex="-1"':''} oninput="calc(${r},${c})">`;
        }
        tr.appendChild(td);
    }
    return tr;
}

function calc(r, c, save=true) {
    const g = (col) => { let el = document.getElementById(`r${r}c${col}`); return el ? (el.type==='checkbox'?el.checked:el.value) : ""; };
    const s = (col, val) => { if(document.getElementById(`r${r}c${col}`)) document.getElementById(`r${r}c${col}`).value = val; };
    let rowCount = parseInt(localStorage.getItem(`rowCount_${curY}`)) || 65;
    if(r === rowCount - 1 && g(c) !== "") { for(let i=0; i<10; i++) document.getElementById('tb').appendChild(createRow(rowCount++)); localStorage.setItem(`rowCount_${curY}`, rowCount); }
    if(g(5).includes('/')) s(0, `${curY}-${g(5).split('/')[0].padStart(2,'0')}`);
    let net = parseFloat(String(g(9)).replace(/,/g,'')) || 0, tax = g(7)?Math.round(net*0.05):0, total = net+tax;
    let rem = total - (parseFloat(g(8))||0) - (parseFloat(g(12))||0);
    s(10, tax); s(11, total); s(13, rem);
    s(17, Math.round(net*(g(14)/100))); s(18, Math.round(net*(g(15)/100))); s(19, Math.round(net*(g(16)/100)));
    
    // çµæ¡ˆè‡ªå‹•è®Šç°
    let row = document.getElementById(`r${r}`);
    if (net > 0 && rem <= 0) row.classList.add('is-settled'); else row.classList.remove('is-settled');

    if(save) { let d = {}; for(let i=0; i<21; i++) d[i] = g(i); localStorage.setItem(`d_${curY}_${r}`, JSON.stringify(d)); }
}

function handleOptChange(r, c) {
    let sel = document.getElementById(`r${r}c${c}`);
    if (sel.value === "__ADD__") {
        let n = prompt("æ–°å¢:"); if (n && n.trim() !== "") { opts[c].push(n.trim()); localStorage.setItem('vB_Opts', JSON.stringify(opts)); initTable(); } else sel.value = "";
    } else if (sel.value === "__DEL__") {
        let target = prompt("åˆªé™¤åç¨±:"); if (target && opts[c].includes(target)) { opts[c] = opts[c].filter(i => i !== target); localStorage.setItem('vB_Opts', JSON.stringify(opts)); initTable(); } else sel.value = "";
    } else calc(r, c);
}

function runSettleSearch() {
    let r = window.curRole, tb = document.getElementById('settle-tb'), tot = 0; tb.innerHTML = '';
    let sc = document.getElementById('ssC').value.trim().toLowerCase();
    let sm = document.getElementById('ssM').value.trim().padStart(2,'0');
    let pIdx = (r==='å…¬å¸'?14:(r==='è€é—†'?15:16)), aIdx = (r==='å…¬å¸'?17:(r==='è€é—†'?18:19));
    document.getElementById('sP').innerText = r+"æŠ½%"; document.getElementById('sA').innerText = r+"é‡‘é¡";
    let count = parseInt(localStorage.getItem(`rowCount_${curY}`)) || 65;
    for(let i=0; i<count; i++) {
        let d = JSON.parse(localStorage.getItem(`d_${curY}_${i}`)) || {}; 
        let val = parseFloat(d[aIdx])||0;
        let rowCust = (d[2]||"").toLowerCase();
        let rowMonth = (d[0]||"").split('-')[1] || "";
        if(val > 0 && (!sc || rowCust.includes(sc)) && (!sm || sm==='00' || rowMonth === sm)) {
            tb.innerHTML += `<tr><td>${d[0]||''}</td><td>${d[1]||''}</td><td>${d[2]||''}</td><td>${d[3]||''}</td><td>${(parseFloat(d[9])||0).toLocaleString()}</td><td>${d[pIdx]||0}%</td><td>${val.toLocaleString()}</td></tr>`; tot += val;
        }
    }
    document.getElementById('settle-total-val').innerText = `çµç®—ç¸½é¡ï¼š$ ${tot.toLocaleString()}`;
}

function updateMonthlyReport() {
    const rt = document.getElementById('report-tb'); rt.innerHTML = ''; let count = parseInt(localStorage.getItem(`rowCount_${curY}`)) || 65;
    for(let m=1; m<=12; m++) {
        let n=0, t=0, r=0, re=0, c1=0, c2=0, c3=0, ct=0, mStr = `${curY}-${String(m).padStart(2,'0')}`;
        for(let i=0; i<count; i++) {
            let d = JSON.parse(localStorage.getItem(`d_${curY}_${i}`)) || {};
            if(d[0] === mStr) { n+=parseFloat(d[9])||0; t+=parseFloat(d[11])||0; r+=(parseFloat(d[8])||0)+(parseFloat(d[12])||0); re+=parseFloat(d[13])||0; c1+=parseFloat(d[17])||0; c2+=parseFloat(d[18])||0; c3+=parseFloat(d[19])||0; ct++; }
        }
        if(ct > 0) rt.innerHTML += `<tr><td>${m}æœˆ</td><td>${n.toLocaleString()}</td><td>${t.toLocaleString()}</td><td>${r.toLocaleString()}</td><td>${re.toLocaleString()}</td><td>${c1.toLocaleString()}</td><td>${c2.toLocaleString()}</td><td>${c3.toLocaleString()}</td><td>${ct}</td></tr>`;
    }
}

async function cloudSync(mode) {
    const btn = document.getElementById('cloudSaveBtn');
    if (mode === 'SAVE') {
        btn.innerText = "â³ åŒæ­¥ä¸­...";
        let fullData = {}; for(let i=0; i<localStorage.length; i++){ let k = localStorage.key(i); if(k.startsWith('d_') || k.startsWith('vB_') || k.startsWith('rowCount_')) fullData[k] = localStorage.getItem(k); }
        try { await fetch(CLOUD_API, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: 'vB_Backup', value: JSON.stringify(fullData) }) }); alert("âœ… æŒ‡ä»¤å·²é€å‡ºï¼"); } catch(e) { alert("âŒ å¤±æ•—"); }
        btn.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥";
    } else {
        if(!confirm("è¼‰å…¥é›²ç«¯ï¼Ÿ")) return;
        try { const res = await fetch(`${CLOUD_API}?key=vB_Backup`); const cloudJson = await res.json(); const data = (typeof cloudJson === 'string') ? JSON.parse(cloudJson) : cloudJson; Object.keys(data).forEach(k => localStorage.setItem(k, data[k])); alert("âœ… è¼‰å…¥æˆåŠŸï¼"); location.reload(); } catch(e) { alert("âŒ è¼‰å…¥å¤±æ•—"); }
    }
}

function exportData() { let b = new Blob([JSON.stringify(localStorage)], {type:'application/json'}); let a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_${curY}.json`; a.click(); }

document.addEventListener('keydown', function(e) {
    if (!e.target.matches('input, select')) return;
    let id = e.target.id;
    if (!id.startsWith('r') || !id.includes('c')) return;
    let parts = id.split('c'), r = parseInt(parts[0].substring(1)), c = parseInt(parts[1]), nextId = null;
    if (e.key === 'ArrowUp') nextId = `r${r-1}c${c}`;
    else if (e.key === 'ArrowDown' || e.key === 'Enter') { 
        nextId = `r${r+1}c${c}`; 
        let maxR = parseInt(localStorage.getItem(`rowCount_${curY}`)) || 65;
        if(r === maxR - 1 && e.key === 'Enter') calc(r, c);
    } else if (e.key === 'ArrowLeft') {
        if (e.target.tagName === 'INPUT' && e.target.type === 'text' && e.target.selectionStart > 0) return;
        nextId = `r${r}c${c-1}`;
    } else if (e.key === 'ArrowRight') {
        if (e.target.tagName === 'INPUT' && e.target.type === 'text' && e.target.selectionStart < e.target.value.length) return;
        nextId = `r${r}c${c+1}`;
    }
    if (nextId) { let el = document.getElementById(nextId); if (el) { e.preventDefault(); el.focus(); if(el.tagName==='INPUT') el.select(); } }
});

window.onload = () => { applyTheme(curY); document.getElementById('yDisp').innerText = curY; initTable(); renderYearList(); };
</script>
</body>
</html>
